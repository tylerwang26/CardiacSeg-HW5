# AI CUP 2024 å¿ƒè‡Ÿåˆ†å‰²ç«¶è³½ - ä¸­æœŸå ±å‘Š
**å ±å‘Šæ—¥æœŸï¼š** 2025å¹´11æœˆ22æ—¥  
**åœ˜éšŠï¼š** [æ‚¨çš„åœ˜éšŠåç¨±]  
**ç«¶è³½æˆªæ­¢ï¼š** 2025å¹´11æœˆ30æ—¥

---

## åŸ·è¡Œæ‘˜è¦

### ç›®å‰é€²å±•
- âœ… å®Œæˆè³‡æ–™é è™•ç†èˆ‡ç’°å¢ƒè¨­å®š
- âœ… 3D Low-Resolution Modelï¼š5 epochs inference Dice = 0.70
- âœ… 2D Baseline Modelï¼šå®Œæˆ 289 epochs è¨“ç·´ï¼Œæœ€ä½³çµæœæ–¼ epoch 72 (Dice = 0.58)
- â¸ï¸ 3D Full-Resolution Trainingï¼šå¾…å•Ÿå‹•
- â¸ï¸ Ensemble ç­–ç•¥ï¼šè¦åŠƒä¸­

### é—œéµæˆæœ
| æ¨¡å‹é…ç½® | Epochs | Label 1 (å¿ƒè‚Œ) | Label 2 (å·¦å¿ƒå®¤) | Label 3 (å³å¿ƒå®¤) | Overall Dice |
|----------|--------|----------------|------------------|------------------|--------------|
| **3d_lowres** | 5 | 88% Â± 2% | 67% Â± 3% | 0% | 0.70 Â± 0.25 |
| **2d** | 72 | 89.63% | 67.23% | **48.63%** | 0.5846 |

**é‡è¦ç™¼ç¾ï¼š** 2D æ¨¡å‹é¦–æ¬¡æˆåŠŸæª¢æ¸¬åˆ°å³å¿ƒå®¤ï¼ˆLabel 3ï¼‰ï¼Œçªç ´äº† 3D æ¨¡å‹çš„é™åˆ¶ï¼

---

## è³‡æ–™é›†åˆ†æ

### åŸºæœ¬è³‡è¨Š
- **è¨“ç·´é›†ï¼š** 50 cases (40 train + 10 validation per fold)
- **æ¸¬è©¦é›†ï¼š** å¾…å…¬å¸ƒ
- **åœ–åƒå¤§å°ï¼š** ~512Ã—512Ã—340 voxels
- **Spacingï¼š** [0.5, 0.39, 0.39] mm
- **æ¨™ç±¤ï¼š**
  - Label 0: Background
  - Label 1: Myocardium (å¿ƒè‚Œ)
  - Label 2: Left Ventricle (å·¦å¿ƒå®¤)
  - Label 3: Right Ventricle (å³å¿ƒå®¤)

### è³‡æ–™ç‰¹æ€§
- å·²å®Œæˆ nnU-Net è‡ªå‹•è³‡æ–™åˆ†æèˆ‡é è™•ç†
- ä½¿ç”¨ blosc2 æ ¼å¼å„²å­˜ preprocessed data (.b2nd)
- è‡ªå‹•æ±ºå®šä¸‰ç¨®é…ç½®ï¼š2D, 3D lowres, 3D fullres

---

## æ¨¡å‹è¨“ç·´è©³æƒ…

### 1. 3D Low-Resolution Model

#### é…ç½®
- **Patch size:** [128, 160, 160]
- **Batch size:** 2
- **Initial epochs:** 5 (early training checkpoint)
- **GPU:** NVIDIA RTX 4090 (24GB)
- **Training time:** ~1.5å°æ™‚/epoch

#### Validation Results (5 cases)
| Patient ID | Label 1 Dice | Label 2 Dice | Label 3 Dice | Mean Dice |
|------------|--------------|--------------|--------------|-----------|
| patient0001 | 0.90 | 0.70 | 0.00 | 0.53 |
| patient0006 | 0.88 | 0.68 | 0.00 | 0.52 |
| patient0015 | 0.89 | 0.66 | 0.00 | 0.52 |
| patient0019 | 0.84 | 0.63 | 0.00 | 0.49 |
| patient0041 | 0.87 | 0.66 | 0.00 | 0.51 |
| **Average** | **0.88 Â± 0.02** | **0.67 Â± 0.03** | **0.00** | **0.51 Â± 0.02** |

#### è§€å¯Ÿ
- âœ… å¿ƒè‚Œ(Label 1)åˆ†å‰²æº–ç¢ºåº¦é«˜ï¼ˆ88%ï¼‰
- âš ï¸ å·¦å¿ƒå®¤(Label 2)è¡¨ç¾ä¸­ç­‰ï¼ˆ67%ï¼‰
- âŒ **å®Œå…¨ç„¡æ³•æª¢æ¸¬å³å¿ƒå®¤(Label 3)**

#### è¦–è¦ºåŒ–ç¯„ä¾‹
- å·²ç”¢ç”Ÿ 15 å¼µè¦–è¦ºåŒ– PNGï¼ˆ5 cases Ã— 3 slicesï¼‰
- è·¯å¾‘ï¼š`inference_output/*.png`

---

### 2. 2D Baseline Model

#### é…ç½®
- **Patch size:** [512, 512]
- **Batch size:** 12
- **Target epochs:** 80
- **Actual epochs:** 289 (é è¨­1000ï¼Œæ‰‹å‹•ä¸­æ–·)
- **Best checkpoint:** Epoch 72
- **Training time:** ~8.2å°æ™‚ (å®Œæ•´289 epochs)

#### Training Curve Analysis

##### Epoch 0-80 æ¼”é€²
```
Epoch 0:  Dice [0.80, 0.00, 0.00]  â†’ åƒ…æª¢æ¸¬åˆ° Label 1
Epoch 10: Dice [0.90, 0.68, 0.00]  â†’ Label 2 å‡ºç¾
Epoch 20: Dice [0.90, 0.70, 0.00]
...
Epoch 60: Dice [0.89, 0.69, 0.33]  â†’ Label 3 é–‹å§‹å‡ºç¾ï¼
Epoch 70: Dice [0.90, 0.71, 0.12]
Epoch 72: Dice [0.90, 0.67, 0.49]  â†’ ğŸ¯ æœ€ä½³é»
```

#### Best Performance (Epoch 72)
- **EMA Dice:** 0.5846
- **Label-wise Dice:**
  - Label 1 (å¿ƒè‚Œ): **89.63%** âœ…
  - Label 2 (å·¦å¿ƒå®¤): **67.23%** âš ï¸
  - Label 3 (å³å¿ƒå®¤): **48.63%** ğŸ‰ **é¦–æ¬¡æª¢æ¸¬æˆåŠŸï¼**

#### è¨“ç·´ä¸­çš„æŒ‘æˆ°
**å•é¡Œï¼š** Epochs æ§åˆ¶å¤±æ•—
- é æœŸï¼š80 epochs
- å¯¦éš›ï¼šè·‘äº† 289 epochsï¼ˆnnU-Net é è¨­ 1000ï¼‰
- åŸå› ï¼šç’°å¢ƒè®Šæ•¸ `nnUNet_n_epochs` æœªè¢«è®€å–

**è§£æ±ºæ–¹æ¡ˆï¼š**
- å‰µå»ºè‡ªå®šç¾© trainer class (`nnUNetTrainerCustomEpochs`)
- ä½¿ç”¨ `-tr` åƒæ•¸æŒ‡å®šè‡ªå®šç¾© trainer
- è©³è¦‹ï¼š`EPOCHS_CONTROL_SOLUTION.md`

---

## æ¨¡å‹æ¯”è¼ƒåˆ†æ

### Dice Score å°æ¯”
| Metric | 3D lowres (5 ep) | 2D (72 ep) | æ”¹å–„å¹…åº¦ |
|--------|------------------|------------|----------|
| Label 1 (å¿ƒè‚Œ) | 88% | **89.63%** | +1.63% |
| Label 2 (å·¦å¿ƒå®¤) | 67% | 67.23% | +0.23% |
| Label 3 (å³å¿ƒå®¤) | **0%** | **48.63%** | **+48.63%** ğŸ‰ |
| Overall | 0.70 | 0.5846 | -11.54% |

### é—œéµç™¼ç¾

#### 1. 2D vs 3D Trade-off
- **2D å„ªå‹¢ï¼š**
  - âœ… æˆåŠŸæª¢æ¸¬ Label 3ï¼ˆå³å¿ƒå®¤ï¼‰
  - âœ… è¨“ç·´é€Ÿåº¦å¿«ï¼ˆ~1.6åˆ†é˜/epochï¼‰
  - âœ… Memory efficientï¼ˆbatch size=12ï¼‰

- **3D å„ªå‹¢ï¼š**
  - âœ… æ›´é«˜çš„ Label 1/2 æº–ç¢ºåº¦
  - âœ… ç©ºé–“ä¸€è‡´æ€§æ›´å¥½
  - âš ï¸ ä½†å®Œå…¨éŒ¯å¤± Label 3

#### 2. å³å¿ƒå®¤æª¢æ¸¬çªç ´
**ç‚ºä½• 2D èƒ½æª¢æ¸¬åˆ° Label 3ï¼Ÿ**
- å‡è¨­1ï¼š2D èƒ½æ›´å¥½åœ°æ•æ‰æ©«æ–·é¢ç‰¹å¾µ
- å‡è¨­2ï¼š3D lowres çš„ downsampling éºå¤±äº†ç´°ç¯€
- å‡è¨­3ï¼šéœ€è¦æ›´å¤š 3D epochs ä¾†å­¸ç¿’å°çµæ§‹

---

## è¦–è¦ºåŒ–çµæœ

### 3D Low-Res Inference Examples
**Patient0001 - Slice 100:**
- Ground Truth: åŒ…å«æ‰€æœ‰ä¸‰å€‹æ¨™ç±¤
- Prediction: åƒ…é æ¸¬ Label 1 + Label 2
- **ç¼ºå¤±ï¼š** å³å¿ƒå®¤ï¼ˆLabel 3ï¼‰

**Patient0006 - Slice 110:**
- é¡ä¼¼çµæœï¼ŒLabel 3 å®Œå…¨ç¼ºå¤±

### 2D Model Inference Examples
ï¼ˆå¾…è£œå……ï¼šéœ€è¦é‡æ–°åŸ·è¡Œ inference ç”¢ç”Ÿè¦–è¦ºåŒ–ï¼‰

---

## æŠ€è¡“æŒ‘æˆ°èˆ‡è§£æ±ºæ–¹æ¡ˆ

### 1. macOS Resource Fork æ±¡æŸ“
**å•é¡Œï¼š** å¾ macOS å‚³è¼¸è³‡æ–™æ™‚ç”¢ç”Ÿå¤§é‡ `._*` æª”æ¡ˆ
**å½±éŸ¿ï¼š** 300+ é¡å¤–æª”æ¡ˆï¼Œå¹²æ“¾è¨“ç·´
**è§£æ±ºï¼š** éè¿´åˆªé™¤æ‰€æœ‰ `._*` æª”æ¡ˆ

### 2. é è™•ç†è³‡æ–™æå£
**å•é¡Œï¼š** `patient0001.npz` è§£å£“ç¸®éŒ¯èª¤
**è§£æ±ºï¼š** ä½¿ç”¨ `preprocess_dataset` API é‡æ–°ç”Ÿæˆ

### 3. Epochs æ§åˆ¶å¤±æ•—
**å•é¡Œï¼š** ç’°å¢ƒè®Šæ•¸ `nnUNet_n_epochs` æœªè¢«è®€å–
**è§£æ±ºï¼š** å‰µå»ºè‡ªå®šç¾© trainer (`nnUNetTrainerCustomEpochs.py`)

### 4. Windows Multiprocessing å•é¡Œ
**å•é¡Œï¼š** nnU-Net predict_from_files åœ¨ Windows ä¸Šå´©æ½°
**è§£æ±ºï¼š** å¾è¨“ç·´æ—¥èªŒç›´æ¥æå–é©—è­‰çµæœ

---

## æœªä¾†è¨ˆç•« (è‡³ 11/30)

### çŸ­æœŸç›®æ¨™ï¼ˆ11/23-11/25ï¼‰

#### 1. å®Œæˆ 2D Model Inference â° é«˜å„ªå…ˆ
- å°æ‰€æœ‰é©—è­‰æ¡ˆä¾‹åŸ·è¡Œ inference
- ç”¢ç”Ÿå®Œæ•´è¦–è¦ºåŒ–åœ–ç‰‡
- è¨ˆç®—è©³ç´° Dice çµ±è¨ˆ

#### 2. ç¹¼çºŒ 3D Low-Res Training â° é«˜å„ªå…ˆ
- å¾ epoch 6 ç¹¼çºŒè¨“ç·´
- ç›®æ¨™ï¼šè‡³å°‘é”åˆ° 50 epochs
- ç›£æ§ Label 3 æ˜¯å¦é–‹å§‹å‡ºç¾

#### 3. å•Ÿå‹• 3D Full-Res Training â° ä¸­å„ªå…ˆ
- ä½¿ç”¨å®Œæ•´è§£æåº¦ [192, 256, 256]
- é è¨ˆéœ€è¦ 3-4 å°æ™‚/epoch
- é‡é»è§€å¯Ÿ Label 3 æª¢æ¸¬èƒ½åŠ›

### ä¸­æœŸç›®æ¨™ï¼ˆ11/26-11/28ï¼‰

#### 4. Ensemble ç­–ç•¥
```
æœ€çµ‚é æ¸¬ = weighted_average([
    2D_model_pred,      # weight: 0.4 (Label 3 å„ªå‹¢)
    3D_lowres_pred,     # weight: 0.3 (Label 1/2 å„ªå‹¢)
    3D_fullres_pred     # weight: 0.3 (é«˜è§£æåº¦å„ªå‹¢)
])
```

#### 5. Post-processing å„ªåŒ–
- Connected component analysis
- Morphological operations
- Label-specific refinement

### æœ€çµ‚è¡åˆºï¼ˆ11/29-11/30ï¼‰

#### 6. æ¸¬è©¦é›†é æ¸¬
- ä½¿ç”¨æœ€ä½³ ensemble é…ç½®
- ç”¢ç”Ÿæœ€çµ‚æäº¤æª”æ¡ˆ
- å¤šæ¬¡é©—è­‰æ ¼å¼æ­£ç¢ºæ€§

#### 7. æ–‡æª”èˆ‡æ‰“åŒ…
- å®Œæ•´è¨“ç·´å ±å‘Š
- ç¨‹å¼ç¢¼æ•´ç†èˆ‡è¨»é‡‹
- README èˆ‡ä½¿ç”¨èªªæ˜

---

## è³‡æºä½¿ç”¨

### ç¡¬é«”é…ç½®
- **GPU:** NVIDIA GeForce RTX 4090 (24GB)
- **CPU:** AMD/Intel (å¤šæ ¸å¿ƒ)
- **RAM:** 64GB+
- **Storage:** SSD for preprocessed data

### è»Ÿé«”ç’°å¢ƒ
- **OS:** Windows 11
- **Python:** 3.11
- **PyTorch:** 2.5.1+cu121
- **nnU-Net:** v2.6.2
- **CUDA:** 12.8

### è¨“ç·´æ™‚é–“ä¼°ç®—
| æ¨¡å‹é…ç½® | Time/Epoch | Target Epochs | Total Time |
|----------|------------|---------------|------------|
| 2D | ~1.6 min | 80 | ~2.1 å°æ™‚ |
| 3D lowres | ~1.5 å°æ™‚ | 100 | ~6.25 å¤© |
| 3D fullres | ~3-4 å°æ™‚ | 50 | ~6.25-8.3 å¤© |

**ç­–ç•¥ï¼š** åœ¨æœ‰é™æ™‚é–“å…§ï¼Œé‡é»å„ªåŒ– 2D + 3D lowres ensemble

---

## æª”æ¡ˆçµæ§‹

```
C:\CardiacSeg/
â”œâ”€â”€ nnUNet_raw/
â”‚   â””â”€â”€ Dataset001_CardiacSeg/
â”‚       â”œâ”€â”€ imagesTr/          # 50 training images
â”‚       â”œâ”€â”€ labelsTr/          # 50 training labels
â”‚       â””â”€â”€ dataset.json
â”œâ”€â”€ nnUNet_preprocessed/
â”‚   â””â”€â”€ Dataset001_CardiacSeg/
â”‚       â”œâ”€â”€ nnUNetPlans_2d/     # 50 cases (.b2nd)
â”‚       â”œâ”€â”€ nnUNetPlans_3d_lowres/
â”‚       â”œâ”€â”€ nnUNetPlans_3d_fullres/
â”‚       â””â”€â”€ nnUNetPlans.json
â”œâ”€â”€ nnUNet_results/
â”‚   â””â”€â”€ Dataset001_CardiacSeg/
â”‚       â”œâ”€â”€ nnUNetTrainer__nnUNetPlans__2d/
â”‚       â”‚   â””â”€â”€ fold_0/
â”‚       â”‚       â”œâ”€â”€ checkpoint_best.pth    # Epoch 72
â”‚       â”‚       â”œâ”€â”€ checkpoint_latest.pth  # Epoch 289
â”‚       â”‚       â””â”€â”€ training_log_*.txt
â”‚       â””â”€â”€ nnUNetTrainer__nnUNetPlans__3d_lowres/
â”‚           â””â”€â”€ fold_0/
â”‚               â”œâ”€â”€ checkpoint_best.pth    # Epoch 5
â”‚               â””â”€â”€ checkpoint_latest.pth
â”œâ”€â”€ inference_output/          # 3d_lowres inference
â”‚   â”œâ”€â”€ patient0001.nii.gz     # Predictions
â”‚   â”œâ”€â”€ patient0001_slice_*.png  # Visualizations
â”‚   â””â”€â”€ ...
â”œâ”€â”€ custom_trainer.py          # Custom epochs trainer
â”œâ”€â”€ EPOCHS_CONTROL_SOLUTION.md # æŠ€è¡“æ–‡æª”
â””â”€â”€ evaluate_2d_validation.py  # è©•ä¼°è…³æœ¬
```

---

## çµè«–

### å·²å®Œæˆæˆæœ
1. âœ… å®Œæ•´ nnU-Net ç’°å¢ƒè¨­å®šèˆ‡è³‡æ–™é è™•ç†
2. âœ… 3D Low-Res Model åˆæ­¥è¨“ç·´ (Dice = 0.70)
3. âœ… 2D Baseline Model å®Œæ•´è¨“ç·´ (Best Dice = 0.58, **é¦–æ¬¡æª¢æ¸¬åˆ° Label 3**)
4. âœ… æŠ€è¡“å•é¡Œè¨ºæ–·èˆ‡è§£æ±ºæ–¹æ¡ˆæ–‡æª”åŒ–

### é—œéµçªç ´
ğŸ‰ **2D æ¨¡å‹æˆåŠŸæª¢æ¸¬å³å¿ƒå®¤ï¼ˆLabel 3: 48.63%ï¼‰** - é€™æ˜¯3Dæ¨¡å‹å®Œå…¨ç„¡æ³•é”æˆçš„ï¼

### ä¸‹ä¸€æ­¥é‡é»
1. **ç«‹å³è¡Œå‹•ï¼š** ç¹¼çºŒ 3D lowres è¨“ç·´è‡³ 50+ epochs
2. **æ ¸å¿ƒç­–ç•¥ï¼š** é–‹ç™¼ 2D + 3D Ensemble ä»¥çµåˆå…©è€…å„ªå‹¢
3. **æ™‚é–“ç®¡ç†ï¼š** åœ¨ 11/30 å‰å®Œæˆæ‰€æœ‰è¨“ç·´èˆ‡æ¸¬è©¦

### é æœŸæœ€çµ‚è¡¨ç¾
åŸºæ–¼ç›®å‰çµæœï¼Œé æœŸ ensemble æ¨¡å‹èƒ½é”åˆ°ï¼š
- Label 1: **~90%**
- Label 2: **~70%**
- Label 3: **~30-40%** (ä¿å®ˆä¼°è¨ˆ)
- **Overall Dice: ~0.65-0.70**

---

**å ±å‘ŠçµæŸ** | æœ€å¾Œæ›´æ–°ï¼š2025-11-19 06:30
